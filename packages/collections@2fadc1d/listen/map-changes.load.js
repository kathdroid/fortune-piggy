montageDefine("2fadc1d","listen/map-changes",{dependencies:["weak-map","../list","../dict"],factory:function(e,t,n){"use strict";function r(){throw Error("Can't construct. MapChanges is a mixin.")}var i=e("weak-map"),a=e("../list");n.exports=r,Object.prototype.hasOwnProperty;var s=new i;r.prototype.getAllMapChangeDescriptors=function(){var t=e("../dict");return s.has(this)||s.set(this,t()),s.get(this)},r.prototype.getMapChangeDescriptor=function(e){var t=this.getAllMapChangeDescriptors();return e=e||"",t.has(e)||t.set(e,{willChangeListeners:new a,changeListeners:new a}),t.get(e)},r.prototype.addMapChangeListener=function(e,t,n){!this.isObservable&&this.makeObservable&&this.makeObservable();var r,i=this.getMapChangeDescriptor(t);r=n?i.willChangeListeners:i.changeListeners,r.push(e),Object.defineProperty(this,"dispatchesMapChanges",{value:!0,writable:!0,configurable:!0,enumerable:!1});var a=this;return function(){a&&(a.removeMapChangeListener(e,t,n),a=null)}},r.prototype.removeMapChangeListener=function(e,t,n){var r,i=this.getMapChangeDescriptor(t);r=n?i.willChangeListeners:i.changeListeners;var a=r.findLast(e);if(!a)throw Error("Can't remove map change listener: does not exist: token "+JSON.stringify(t));a["delete"]()},r.prototype.dispatchMapChange=function(e,t,n){var r=this.getAllMapChangeDescriptors(),i="Map"+(n?"WillChange":"Change");r.forEach(function(r,a){if(!r.isActive){r.isActive=!0;var s;s=n?r.willChangeListeners:r.changeListeners;var o="handle"+(a.slice(0,1).toUpperCase()+a.slice(1))+i;try{s.forEach(function(n){if(n[o])n[o](t,e,this);else{if(!n.call)throw Error("Handler "+n+" has no method "+o+" and is not callable");n.call(n,t,e,this)}},this)}finally{r.isActive=!1}}},this)},r.prototype.addBeforeMapChangeListener=function(e,t){return this.addMapChangeListener(e,t,!0)},r.prototype.removeBeforeMapChangeListener=function(e,t){return this.removeMapChangeListener(e,t,!0)},r.prototype.dispatchBeforeMapChange=function(e,t){return this.dispatchMapChange(e,t,!0)}}});